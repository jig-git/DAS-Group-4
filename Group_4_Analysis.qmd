---
title: " Data Analysis Group 4"
number-sections: true
format: 
  html:
    embed-resources: true
    code-tools: true
---

```{r}
#| echo: false
#| warning: false

library(tidymodels)
library(readr)
DAProject8 <- read_csv("DAProject8.csv")
```

# Introduction {#sec-intro}

Obesity health concerns are a major issue in Scotland impacting the healthy well-being of individuals across the country. The Body Mass Index (BMI) is a measure to assess weight-related health issues and is used widely across the world to provide insight into the populations health. The Scottish Health Survey (2008-2012) demonstrates how social-economic and lifestyle factors may affect the BMI distribution of the Scottish Population. The survey uses factors such as age, sex, employment status, vegetable intake, fruit intake and more to understand the relationship between social-economic, lifestyle factors and health outcomes of the Scottish population. Here, we shall analyse these relationships and conclude whether there has been a difference in BMI distribution in Scotland over the given years.

@sec-exploratory consists of the exploratory analysis of the survey's data and explores the potential trends between the social-economic and lifestyle factors and the BMI, and whether, there are any differences in the BMI over the given years.

@sec-FA contains the results from fitting a multiple regression model to the data, as well as the assessment of the model assumptions. Through exploratory analysis and statistical tests the concluding remarks will be given in @sec-conclusion.

# Exploratory Analysis {#sec-exploratory}

In this section , we will explore the distribution of BMI from our `DAProject8` dataset.

We summarise BMI patterns and visualise distributions to investigate changes over time and differences by age, sex, employment, and diet (specifically fruit and veg intake).

This will allow us to inform our @sec-FA, by checking **normality** **and variance assumptions**.

```{r}
#| echo: false
#| warning: false
#| message: false
#| label: setup

library(tidyverse)
library(gt)

DAProject8 <- DAProject8 %>%
  mutate(
    AgeGroup = as.factor(AgeGroup),
    Sex = as.factor(Sex),
    Employment = as.factor(Employment),
    Veg = as.factor(Veg),
    Fruit = as.factor(Fruit),
    Year = as.factor(Year)
  )
```

## Summary Statistics

We first examine overall BMI and its variation by year. @tbl-bmi-summary shows the overall range and central tendency, while @tbl-bmi-year tracks changes over time.

```{r}
#| echo: false
#| eval: true
#| label: tbl-bmi-summary
#| tbl-cap: "Overall Summary Statistics of BMI"

bmi_summary <- DAProject8 %>%
  summarise(
    "Min" = min(BMI, na.rm = TRUE),
    "Q1" = quantile(BMI, 0.25, na.rm = TRUE),
    "Median" = median(BMI, na.rm = TRUE),
    "Mean" = mean(BMI, na.rm = TRUE),
    "Q3" = quantile(BMI, 0.75, na.rm = TRUE),
    "Max" = max(BMI, na.rm = TRUE)
  ) %>%
  gt() %>%
  fmt_number(decimals = 2) %>%
  cols_label(
    Min = "Minimum",
    Q1 = "1st Quartile",
    Median = "Median",
    Mean = "Mean",
    Q3 = "3rd Quartile",
    Max = "Maximum"
  )
bmi_summary
```

```{r}
#| echo: false
#| eval: true
#| label: tbl-bmi-year
#| tbl-cap: "Mean, Median, and Standard Deviation of BMI by Year"

bmi_by_year <- DAProject8 %>%
  group_by(Year) %>%
  summarise(
    "Mean_BMI" = mean(BMI, na.rm = TRUE),
    "Median_BMI" = median(BMI, na.rm = TRUE),
    "SD_BMI" = sd(BMI, na.rm = TRUE),
    "N" = n()
  ) %>%
  gt() %>%
  fmt_number(decimals = 2) %>%
  cols_label(
    Mean_BMI = "Mean",
    Median_BMI = "Median",
    SD_BMI = "Std. Dev",
    N = "Sample Size"
  )
bmi_by_year
```

As we can see, \@tbl-bmi-year shows that the mean BMI remains between 27 and 28 across the years in question, with a narrow range of standard deviations between the values 5.16 and 5.36, indicating no clear trend over time but consistent variability.

## BMI Distribution and Normality

@fig-bmi-hist displays the overall BMI distribution.

```{r}
#| echo: false
#| eval: true
#| label: fig-bmi-hist
#| fig-cap: "Histogram of BMI Distribution (2008-2012)"

bmi_hist <- ggplot(DAProject8, aes(x = BMI)) +
  geom_histogram(binwidth = 2, fill = "dodgerblue4", color = "white") +
  labs(title = "Distribution of BMI in Scotland (2008-2012)",
       x = "BMI", y = "Count")
bmi_hist
```

The distribution appears slightly right-skewed, with a peak near 26, suggesting potential non-normality.

@fig-bmi-qq assesses normality with a Q-Q plot. Deviation at the tails confirms skewness, suggesting a transformation (such as a log-transform) may be needed for @sec-FA.

```{r}
#| echo: false
#| eval: true
#| label: fig-bmi-qq
#| fig-cap: "Q-Q Plot of BMI for Normality Assessment"

qqnorm(DAProject8$BMI, main = "Q-Q Plot of BMI")
qqline(DAProject8$BMI, col = "firebrick1")
```

@fig-bmi-resid checks variance consistency across years by plotting residuals (BMI minus yearly mean). Similar boxplot spreads suggest roughly equal variance, supporting potential ANOVA or regression in @sec-FA, with each year highlighted in a distinct color.

```{r}
#| echo: false
#| eval: true
#| label: fig-bmi-resid
#| fig-cap: "Boxplot of BMI Residuals by Year"

# Calculate residuals: BMI - mean BMI per year
DAProject8 <- DAProject8 %>%
  group_by(Year) %>%
  mutate(Mean_BMI = mean(BMI, na.rm = TRUE),
         Residual = BMI - Mean_BMI)

bmi_resid_box <- ggplot(DAProject8, aes(x = Year, y = Residual, fill = Year)) +
  geom_boxplot() +
  scale_fill_manual(values = c("2008" = "lightblue", 
                               "2009" = "lightgreen", 
                               "2010" = "lightpink", 
                               "2011" = "lightcoral", 
                               "2012" = "lightgoldenrodyellow")) +
  labs(title = "BMI Residuals by Year",
       x = "Year", y = "Residual (BMI - Yearly Mean)", fill = "Year")
bmi_resid_box
```

## BMI Over Time

@fig-bmi-year shows BMI by year. Medians are stable near 27, with outliers above 50, indicating no major change over 2008--2012.

```{r}
#| echo: false
#| eval: true
#| label: fig-bmi-year
#| fig-cap: "Boxplot of BMI by Year"

bmi_year_box <- ggplot(DAProject8, aes(x = Year, y = BMI)) +
  geom_boxplot(fill = "lightgreen") +
  labs(title = "BMI Distribution by Year",
       x = "Year", y = "BMI")
bmi_year_box
```

## Differences Observed by Other Factors

We will now explore differences in BMI by age, sex, employment, and diet. @fig-bmi-diet facets BMI by vegetable and fruit intake across years, visually assessing diet effects over time.

```{r}
#| echo: false
#| eval: true
#| label: fig-bmi-diet
#| fig-cap: "Boxplot of BMI by Year and Diet"

DAProject8 <- DAProject8 %>%
  mutate(Veg_Fruit = interaction(Veg, Fruit, sep = "/"))

bmi_diet_box <- ggplot(DAProject8, aes(x = Year, y = BMI, fill = Veg_Fruit)) +
  geom_boxplot() +
  facet_grid(Veg ~ Fruit) +
  scale_fill_manual(values = c("Yes/Yes" = "green3", 
                               "Yes/No" = "lightgoldenrod1", 
                               "No/Yes" = "lightskyblue", 
                               "No/No" = "firebrick3")) +
  labs(title = "BMI by Year, Vegetable, and Fruit Intake",
       x = "Year", y = "BMI", fill = "Veg/Fruit")
bmi_diet_box
```

# Formal Analysis {#sec-FA}

We start by fitting the full multiple regression model containing all explanatory variables. The full model can be written as:

$$\begin{align}
y_{i} &= \alpha + \beta_{AgeGroup} \cdot \mathbb{I}_{AgeGroup}(x) + \beta_{Sex} \cdot \mathbb{I}_{Sex}(x) + \beta_{Employment} \cdot \mathbb{I}_{Employment}(x) + \beta_{Veg}\cdot \mathbb{I}_{Veg}(x) + \beta_{Fruit} \cdot \mathbb{I}_{Fruit}(x) + \beta_{Year} \cdot \mathbb{I}_{Year}(x) + \epsilon_i, \\
& ~~~~ \epsilon_i \sim N(0, \sigma^2), ~~~~ i=1,\ldots,n 
\end{align}$$

where:

-   $\alpha$ is the intercept of the regression line for the baseline of fruit and veg being 'no'.

-   $\beta_{AgeGroup}$ is the intercept of the regression line for the specified age group.

```         
-   $\mathbb{I}_{AgeGroup}(x)$ is an indicator function indicating the Age Group.
```

-   $\beta_{Sex}$ is the intercept of the regression line for the specified gender.

    -   $\mathbb{I}_{Sex}(x) = \{\begin{array}{rcl} 1&\mbox{for male} \\ 0&otherwise \end{array}$

-   $\beta_{Employment}$ is the intercept of the regression line for the specified employment status.

    -   $\mathbb{I}_{Employment}(x)$ is an indicator function indicating the Employment Status.

-   $\beta_{Veg}$ is the intercept of the regression line for the specified vegetable intake.

    -   $\mathbb{I}_{Veg}(x) = \{\begin{array}{rcl} 1&\mbox{for yes} \\ 0&otherwise \\ \end{array}$

-   $\beta_{Fruit}$ is the intercept of the regression line for the specified fruit intake.

    -   $\mathbb{I}_{Fruit}(x) = \{\begin{array}{rcl} 1&\mbox{for yes} \\ 0&otherwise \end{array}$

-   $\beta_{Year}$ is the intercept of the regression line for the year.

    -   $\mathbb{I}_{Year}(x)$ is an indicator function indicating the year.

-   $\epsilon_i$ represents normally distributed errors.

To refine the model, since there are so many variables, we apply stepwise regression with backward selection in order to reduce the model based on the Akaike Information Criterion (AIC). In doing this, we aim to identify the best-fitting model.

```{r}
#| warning: false
#| echo: false

library(ggplot2)
library(tidyverse)
library(gt)
library(MASS)
library(moderndive)

#regression model
bmi_model <- lm(BMI ~ AgeGroup + Sex + Employment + Veg + Fruit + Year, data = DAProject8)
bmi_model
#Stepwise selection using backward elimination
step_model <- stepAIC(bmi_model, direction = "backward", trace = FALSE)
AIC <- step_model$anova
```

The stepwise selection process determines whether all predictors should be included or if a reduced model provides a better fit. In this case, the final model has the lowest AIC of 82517.56, thus is the chosen model.

The final regression model results are summarized in @tbl-regtable

```{r}
#| echo: false
#| label: tbl-regtable
#| tbl-cap: Estimates of the regression model coeeficients


# Display final selected model coefficients
gt(get_regression_table(step_model)) |> fmt_number(decimals = 3)
```

@tbl-regtable provides estimates of the regression model coefficients, showing which factors significantly impact BMI.

To ensure that regression assumptions hold, we analyse residuals demonstrated in the figure below.

```{r}
#|echo: false
#|label: fig-residassump

# Residual plots
par(mfrow = c(2, 2))
plot(step_model)
par(mfrow = c(1, 1))
```

The residual plots help check for normality, homoscedasticity, and potential outliers, all of which seem satisfied.

To confirm the validity of model assumptions, we visualise the normality of the residuals in the histogram below.

```{r}
#| echo: false
#| label: fig-normalresid

# Plot residuals
library(ggplot2)
ggplot(data = data.frame(residuals = residuals(step_model)), aes(x = residuals)) +
  geom_histogram(binwidth = 1, fill = "gray", color = "black") +
  labs(title = "Histogram of Residuals", x = "Residuals", y = "Count")
```

The histogram verifies that the residuals are approximately normally distributed as it is bell-shaped and centered at zero.

## Interaction Effects

We test for interactions between Sex and Employment, and Veg and Fruit to explore whether dietary factors interact with employment status or gender.

```{r}
#| echo: false
# Interaction model
interaction_model <- lm(BMI ~ AgeGroup * Sex + Employment * Veg + Fruit + Year, data = DAProject8)

# Compare models
anova(step_model, interaction_model)
```

The ANOVA test assesses whether including interaction terms significantly improves model fit.

## Summary of Findings

-   Certain socio-economic and lifestyle factors significantly impact BMI.
-   Interaction effects between dietary intake and employment status were explored.
-   Stepwise selection refined the model for better interpretability.
-   Diagnostic plots confirm that regression assumptions hold.
-   Residual analysis supports model validity.

The next section will provide concluding remarks based on these findings.

# Conclusions {#sec-conclusion}
